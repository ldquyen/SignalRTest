<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chat Client V2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .message-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .file-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .message-type-selector {
            margin: 10px 0;
        }
        
        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .chat-message.own {
            background-color: #e3f2fd;
            text-align: right;
        }
        
        .chat-message.other {
            background-color: #f5f5f5;
        }
        
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 5px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="section">
        <h2>üîê ƒêƒÉng nh·∫≠p</h2>
        <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" style="width: 200px;" />
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" style="width: 200px;" />
        <button onclick="signIn()">ƒêƒÉng nh·∫≠p</button>
    </div>

    <div class="section">
        <h2>üë§ Th√¥ng tin Profile:</h2>
        <div id="profile-details"></div>
    </div>

    <div class="section">
        <h2>üí¨ Chat</h2>
        <input type="text" id="roomId" placeholder="Nh·∫≠p Room ID (GUID)" style="width: 300px;" />
        <button onclick="joinChatRoom()">Tham gia ph√≤ng</button>
        <br><br>
        
        <div id="chat-box"
            style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; background-color: #f9f9f9;">
        </div>
        
        <div class="message-type-selector">
            <label>
                <input type="radio" name="messageType" value="0" checked> üìù Tin nh·∫Øn vƒÉn b·∫£n
            </label>
            <label style="margin-left: 20px;">
                <input type="radio" name="messageType" value="1"> üñºÔ∏è G·ª≠i h√¨nh ·∫£nh
            </label>
        </div>
        
        <div class="message-input-container">
            <input type="text" id="chat-message" placeholder="Nh·∫≠p tin nh·∫Øn..." style="width: 300px;" />
            <button onclick="sendMessage()">üì® G·ª≠i</button>
        </div>
        
        <div class="file-input-container" id="file-input-container" style="display: none;">
            <input type="file" id="image-file" accept=".jpg,.jpeg,.png" />
            <button onclick="clearImagePreview()">üóëÔ∏è X√≥a ·∫£nh</button>
        </div>
        
        <div id="image-preview-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        let connection;
        let accountId = null;
        let currentRoom = null;
        let currentUserInfo = null;

        // X·ª≠ l√Ω thay ƒë·ªïi lo·∫°i tin nh·∫Øn
        document.addEventListener('DOMContentLoaded', function() {
            const messageTypeRadios = document.querySelectorAll('input[name="messageType"]');
            messageTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleMessageInputType();
                });
            });
        });

        function toggleMessageInputType() {
            const selectedType = document.querySelector('input[name="messageType"]:checked').value;
            const fileContainer = document.getElementById('file-input-container');
            const textInput = document.getElementById('chat-message');
            
            if (selectedType === '1') { // Image message (MessageTypeEnum.Image = 1)
                fileContainer.style.display = 'flex';
                textInput.placeholder = 'M√¥ t·∫£ cho ·∫£nh (t√πy ch·ªçn)...';
            } else { // Text message (MessageTypeEnum.Text = 0)
                fileContainer.style.display = 'none';
                textInput.placeholder = 'Nh·∫≠p tin nh·∫Øn...';
                clearImagePreview();
            }
        }

        function clearImagePreview() {
            document.getElementById('image-file').value = '';
            document.getElementById('image-preview-container').innerHTML = '';
        }

        // Xem tr∆∞·ªõc ·∫£nh khi ch·ªçn file
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('image-file');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const previewContainer = document.getElementById('image-preview-container');
                    
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewContainer.innerHTML = `
                                <div style="margin-top: 10px;">
                                    <p><strong>Xem tr∆∞·ªõc ·∫£nh:</strong></p>
                                    <img src="${e.target.result}" class="preview-image" alt="Preview" />
                                    <p><em>K√≠ch th∆∞·ªõc: ${(file.size / 1024 / 1024).toFixed(2)} MB</em></p>
                                </div>
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        previewContainer.innerHTML = '';
                    }
                });
            }
        });

        function signIn() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            if (!username || !password) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }

            fetch("https://localhost:7229/api/v1/auth/sign-in", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.isSuccess) {
                        const token = data.responseRequestModel.jwtToken.accessToken;
                        accountId = data.responseRequestModel.accountID;
                        currentUserInfo = data.responseRequestModel;
                        sessionStorage.setItem("accessToken", token);
                        sessionStorage.setItem("accountId", accountId);
                        getProfileInfo(token);
                        connectToChatHub(token);
                    } else {
                        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + data.message);
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi ƒëƒÉng nh·∫≠p:", err);
                    alert("L·ªói khi ƒëƒÉng nh·∫≠p.");
                });
        }

        function getProfileInfo(token) {
            fetch('https://localhost:7229/api/v1/auth/profile', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.isSuccess) {
                        const p = data.responseRequestModel;
                        document.getElementById("profile-details").innerHTML = ` 
                            <strong>Full Name:</strong> ${p.fullName} <br>
                            <strong>Email:</strong> ${p.email} <br>
                            <strong>Phone:</strong> ${p.phoneNumber} <br>
                            <strong>Gender:</strong> ${p.genderDisplay} <br>
                            <strong>Role:</strong> ${p.roleDisplay} <br>
                            <strong>Created At:</strong> ${p.createdAt}
                        `;
                    } else {
                        document.getElementById("profile-details").innerText = "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin profile.";
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi l·∫•y profile:", err);
                    document.getElementById("profile-details").innerText = "L·ªói khi l·∫•y profile.";
                });
        }

        function connectToChatHub(token) {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7229/chatHub", {
                    accessTokenFactory: () => token
                })
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveMessage", (senderId, messageObj) => {
                const chatBox = document.getElementById("chat-box");
                const msgElement = document.createElement("div");
                msgElement.className = "chat-message";

                const message = messageObj.message;
                const messageType = messageObj.messageType;
                const isOwnMessage = senderId === accountId;
                
                if (isOwnMessage) {
                    msgElement.classList.add("own");
                } else {
                    msgElement.classList.add("other");
                }

                let messageContent = '';
                // MessageTypeEnum.Image = 1
                if (messageType === 'Image' || messageType === 1 || messageType === '1') {
                    messageContent = `
                        <strong>${senderId}:</strong> 
                        <br><img src="${message}" class="message-image" alt="Shared image" onclick="openImageModal('${message}')" style="cursor: pointer;" />
                        <br><em>(${new Date().toLocaleTimeString()})</em>
                    `;
                } else {
                    messageContent = `<strong>${senderId}:</strong> ${message} <em>(${new Date().toLocaleTimeString()})</em>`;
                }

                msgElement.innerHTML = messageContent;
                chatBox.appendChild(msgElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            connection.start()
                .then(() => {
                    console.log("‚úÖ ƒê√£ k·∫øt n·ªëi ChatHub");
                })
                .catch(err => {
                    console.error("L·ªói khi k·∫øt n·ªëi ChatHub:", err);
                });
        }

        function openImageModal(imageSrc) {
            // T·∫°o modal ƒë·ªÉ xem ·∫£nh full size
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.8); display: flex;
                justify-content: center; align-items: center; z-index: 1000;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 10px;';
            
            modal.appendChild(img);
            modal.onclick = () => document.body.removeChild(modal);
            
            document.body.appendChild(modal);
        }

        function joinChatRoom() {
            const roomId = document.getElementById("roomId").value.trim();
            if (!roomId) {
                alert("Vui l√≤ng nh·∫≠p Room ID!");
                return;
            }

            const token = sessionStorage.getItem("accessToken");
            const chatBox = document.getElementById("chat-box");
            const msgElement = document.createElement("div");
            msgElement.innerHTML = `<em>ƒêang x·ª≠ l√Ω tham gia ph√≤ng ${roomId}...</em>`;
            chatBox.appendChild(msgElement);
            chatBox.scrollTop = chatBox.scrollHeight;

            currentRoom = roomId;

            const formData = new FormData();
            formData.append('RoomChatID', roomId);
            formData.append('Message', '[JOIN_ROOM]');
            formData.append('MessageType', '1');

            fetch("https://localhost:7229/api/v1/chat", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.isSuccess) {
                        const joinMsg = document.createElement("div");
                        joinMsg.innerHTML = `<em>${data.responseRequestModel.message}</em>`;
                        chatBox.appendChild(joinMsg);
                        chatBox.scrollTop = chatBox.scrollHeight;
                        console.log(`‚úÖ ƒê√£ tham gia v√†o ph√≤ng: ${roomId}`);
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi tham gia ph√≤ng chat:", err);
                    const errorMsg = document.createElement("div");
                    errorMsg.innerHTML = `<em style="color: red">L·ªói khi tham gia ph√≤ng: ${err.message}</em>`;
                    chatBox.appendChild(errorMsg);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
        }

        function sendMessage() {
            const room = document.getElementById("roomId").value.trim();
            const message = document.getElementById("chat-message").value.trim();
            const token = sessionStorage.getItem("accessToken");
            const selectedType = document.querySelector('input[name="messageType"]:checked').value;
            const imageFile = document.getElementById("image-file").files[0];

            if (!room) {
                alert("Vui l√≤ng nh·∫≠p Room ID!");
                return;
            }

            // Ki·ªÉm tra ƒëi·ªÅu ki·ªán d·ª±a tr√™n lo·∫°i tin nh·∫Øn
            if (selectedType === '2') { // Image message
                if (!imageFile) {
                    alert("Vui l√≤ng ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i!");
                    return;
                }
                
                // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(imageFile.type)) {
                    alert("Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh ƒë·ªãnh d·∫°ng JPG, JPEG, PNG!");
                    return;
                }
                
                // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (2MB)
                if (imageFile.size > 2 * 1024 * 1024) {
                    alert("K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 2MB!");
                    return;
                }
            } else { // Text message
                if (!message) {
                    alert("Vui l√≤ng nh·∫≠p tin nh·∫Øn!");
                    return;
                }
            }

            // T·∫°o FormData ƒë·ªÉ g·ª≠i
            const formData = new FormData();
            formData.append('RoomChatID', room);
            formData.append('MessageType', selectedType);
            
            if (selectedType === '2') {
                // G·ª≠i ·∫£nh
                formData.append('Message', message || 'ƒê√£ g·ª≠i m·ªôt h√¨nh ·∫£nh');
                formData.append('Image', imageFile);
            } else {
                // G·ª≠i tin nh·∫Øn vƒÉn b·∫£n
                formData.append('Message', message);
            }

            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang g·ª≠i
            const chatBox = document.getElementById("chat-box");
            const sendingMsg = document.createElement("div");
            sendingMsg.innerHTML = `<em style="color: #666;">ƒêang g·ª≠i${selectedType === '2' ? ' ·∫£nh' : ''}...</em>`;
            chatBox.appendChild(sendingMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

            fetch("https://localhost:7229/api/v1/chat", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    // X√≥a th√¥ng b√°o ƒëang g·ª≠i
                    chatBox.removeChild(sendingMsg);
                    
                    if (data.isSuccess) {
                        // X√≥a input sau khi g·ª≠i th√†nh c√¥ng
                        document.getElementById("chat-message").value = "";
                        if (selectedType === '2') {
                            clearImagePreview();
                        }
                        console.log("ƒê√£ g·ª≠i:", data.responseRequestModel.message);
                    } else {
                        alert("L·ªói g·ª≠i tin nh·∫Øn: " + data.message);
                    }
                })
                .catch(err => {
                    // X√≥a th√¥ng b√°o ƒëang g·ª≠i
                    chatBox.removeChild(sendingMsg);
                    console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", err);
                    alert("L·ªói khi g·ª≠i tin nh·∫Øn: " + err.message);
                });
        }

        // Cho ph√©p g·ª≠i tin nh·∫Øn b·∫±ng Enter
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-message');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });
    </script>
</body>

</html>