<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chat Client V2</title>
</head>

<body>
    <h2>üîê ƒêƒÉng nh·∫≠p</h2>
    <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" style="width: 200px;" />
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" style="width: 200px;" />
    <button onclick="signIn()">ƒêƒÉng nh·∫≠p</button>

    <h2>üë§ Th√¥ng tin Profile:</h2>
    <div id="profile-details"></div>

    <h2>üí¨ Chat</h2>
    <input type="text" id="roomId" placeholder="Nh·∫≠p Room ID (GUID)" style="width: 300px;" />
    <button onclick="joinChatRoom()">Tham gia ph√≤ng</button>
    <br><br>
    <div id="chat-box"
        style="border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; background-color: #f9f9f9;">
    </div>
    <br>
    <input type="text" id="chat-message" placeholder="Nh·∫≠p tin nh·∫Øn..." style="width: 300px;" />
    <button onclick="sendMessage()">üì® G·ª≠i</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        let connection;
        let accountId = null;
        let currentRoom = null;

        function signIn() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            if (!username || !password) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }

            fetch("https://localhost:7229/api/v1/auth/sign-in", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.isSuccess) {
                        const token = data.responseRequestModel.jwtToken.accessToken;
                        accountId = data.responseRequestModel.accountID;
                        sessionStorage.setItem("accessToken", token);
                        sessionStorage.setItem("accountId", accountId);
                        getProfileInfo(token);
                        connectToChatHub(token);
                    } else {
                        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + data.message);
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi ƒëƒÉng nh·∫≠p:", err);
                    alert("L·ªói khi ƒëƒÉng nh·∫≠p.");
                });
        }

        function getProfileInfo(token) {
            fetch('https://localhost:7229/api/v1/auth/profile', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.isSuccess) {
                        const p = data.responseRequestModel;
                        document.getElementById("profile-details").innerHTML = ` 
                            <strong>Full Name:</strong> ${p.fullName} <br>
                            <strong>Email:</strong> ${p.email} <br>
                            <strong>Phone:</strong> ${p.phoneNumber} <br>
                            <strong>Gender:</strong> ${p.genderDisplay} <br>
                            <strong>Role:</strong> ${p.roleDisplay} <br>
                            <strong>Created At:</strong> ${p.createdAt}
                        `;
                    } else {
                        document.getElementById("profile-details").innerText = "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin profile.";
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi l·∫•y profile:", err);
                    document.getElementById("profile-details").innerText = "L·ªói khi l·∫•y profile.";
                });
        }

        function connectToChatHub(token) {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7229/chatHub", {
                    accessTokenFactory: () => token
                })
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveMessage", (senderIdOrObject, messageParam) => {
                const chatBox = document.getElementById("chat-box");
                const msgElement = document.createElement("div");

                if (typeof senderIdOrObject === 'object' && senderIdOrObject !== null) {
                    const messageObj = senderIdOrObject;
                    msgElement.innerHTML = `<strong>${messageObj.senderId}:</strong> ${messageObj.message} <em>(${new Date(messageObj.time).toLocaleTimeString()})</em>`;
                } else {
                    const senderId = senderIdOrObject;
                    const message = messageParam;
                    msgElement.innerHTML = `<strong>${senderId}:</strong> ${message} <em>(${new Date().toLocaleTimeString()})</em>`;
                }

                chatBox.appendChild(msgElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            connection.start()
                .then(() => {
                    console.log("‚úÖ ƒê√£ k·∫øt n·ªëi ChatHub");
                })
                .catch(err => {
                    console.error("L·ªói khi k·∫øt n·ªëi ChatHub:", err);
                });
        }

        function joinChatRoom() {
            const roomId = document.getElementById("roomId").value.trim();
            if (!roomId) {
                alert("Vui l√≤ng nh·∫≠p Room ID!");
                return;
            }

            const token = sessionStorage.getItem("accessToken");

            const chatBox = document.getElementById("chat-box");
            const msgElement = document.createElement("div");
            msgElement.innerHTML = `<em>ƒêang x·ª≠ l√Ω tham gia ph√≤ng ${roomId}...</em>`;
            chatBox.appendChild(msgElement);
            chatBox.scrollTop = chatBox.scrollHeight;

            currentRoom = roomId;

            fetch("https://localhost:7229/api/v1/chat?" + new URLSearchParams({
                room: roomId,
                message: "[JOIN_ROOM]"
            }), {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.isSuccess) {
                        const joinMsg = document.createElement("div");
                        joinMsg.innerHTML = `<em>${data.responseRequestModel.message}</em>`;
                        chatBox.appendChild(joinMsg);
                        chatBox.scrollTop = chatBox.scrollHeight;
                        console.log(`‚úÖ ƒê√£ tham gia v√†o ph√≤ng: ${roomId}`);
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi tham gia ph√≤ng chat:", err);
                    const errorMsg = document.createElement("div");
                    errorMsg.innerHTML = `<em style="color: red">L·ªói khi tham gia ph√≤ng: ${err.message}</em>`;
                    chatBox.appendChild(errorMsg);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
        }

        function sendMessage() {
            const room = document.getElementById("roomId").value.trim();
            const message = document.getElementById("chat-message").value.trim();
            const token = sessionStorage.getItem("accessToken");

            if (!room || !message) {
                alert("Vui l√≤ng nh·∫≠p Room ID v√† tin nh·∫Øn!");
                return;
            }

            fetch("https://localhost:7229/api/v1/chat?" + new URLSearchParams({ room, message }), {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.isSuccess) {
                        document.getElementById("chat-message").value = "";
                        console.log(data.responseRequestModel.message);
                    } else {
                        alert("L·ªói g·ª≠i tin nh·∫Øn: " + data.message);
                    }
                })
                .catch(err => console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", err));
        }
    </script>
</body>

</html>