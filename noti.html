<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Notification Client</title>
</head>

<body>
    <h2>üîê ƒêƒÉng nh·∫≠p</h2>
    <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" style="width: 200px;" />
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" style="width: 200px;" />
    <button onclick="signIn()">ƒêƒÉng nh·∫≠p</button>

    <h2>üë§ Th√¥ng tin Profile:</h2>
    <div id="profile-details"></div>

    <h2>üí∞ V√≠ c·ªßa b·∫°n:</h2>
    <div id="wallet-details">ƒêang t·∫£i v√≠...</div>

    <h2>üîî Danh s√°ch th√¥ng b√°o:</h2>
    <button onclick="reloadNotifications()" style="margin-bottom: 10px;">üîÑ T·∫£i l·∫°i th√¥ng b√°o</button>
    <ul id="noti-list"></ul>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        let connection;
        let accountId = null;

        function signIn() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            if (!username || !password) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }

            fetch("https://pdcbackendapi.tlog.website/api/v1/auth/sign-in", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username, password })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.isSuccess) {
                        const token = data.responseRequestModel.jwtToken.accessToken;
                        accountId = data.responseRequestModel.accountID;
                        localStorage.setItem("accessToken", token);
                        localStorage.setItem("accountId", accountId);
                        connectToHub(token);
                        getProfileInfo(token);
                        getWalletInfo(token);
                        getNotifications(token, accountId);
                    } else {
                        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + data.message);
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi ƒëƒÉng nh·∫≠p:", err);
                    alert("L·ªói khi ƒëƒÉng nh·∫≠p.");
                });
        }

        function joinChatRoom(roomId) {
            if (!connection) {
                console.error("Connection ch∆∞a s·∫µn s√†ng.");
                return;
            }

            connection.invoke("JoinRoom", roomId)
                .then(() => console.log("‚úÖ ƒê√£ join ph√≤ng: " + roomId))
                .catch(err => console.error("‚ùå L·ªói khi join ph√≤ng:", err));
        }


        function connectToHub(token) {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://pdcbackendapi.tlog.website/notificationHub", {
                    accessTokenFactory: () => localStorage.getItem("accessToken")
                })
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveNotification", (notification) => {
                console.log("üì® Nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o m·ªõi:", notification);
                addNotificationToList(notification);
            });

            connection.on("NotificationDeleted", (notificationId) => {
                const item = document.getElementById(notificationId);
                if (item) item.remove();
            });

            connection.on("ReceiveMessage", (message) => {
                console.log("üí¨ Nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn:", message);
                const chatBox = document.getElementById("chat-box");
                const msgElement = document.createElement("div");
                msgElement.innerHTML = `<strong>${message.senderId}:</strong> ${message.message}`;
                chatBox.appendChild(msgElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            connection.start()
                .then(() => console.log("‚úÖ K·∫øt n·ªëi SignalR th√†nh c√¥ng"))
                .catch(err => {
                    console.error("‚ùå L·ªói khi k·∫øt n·ªëi hub:", err);
                    alert("L·ªói khi k·∫øt n·ªëi Hub: " + err);
                });
        }

        function sendMessage() {
            const roomId = document.getElementById("roomId").value.trim();
            const message = document.getElementById("chat-message").value.trim();
            const senderId = localStorage.getItem("accountId");

            if (!roomId || !message) {
                alert("Vui l√≤ng nh·∫≠p Room ID v√† tin nh·∫Øn!");
                return;
            }

            connection.invoke("SendMessageToRoom", {
                roomId,
                senderId,
                message
            }).then(() => {
                document.getElementById("chat-message").value = "";
            }).catch(err => {
                console.error("‚ùå L·ªói khi g·ª≠i tin nh·∫Øn:", err);
            });
        }

        function getProfileInfo(token) {
            fetch('https://pdcbackendapi.tlog.website/api/v1/auth/profile', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.isSuccess) {
                        const p = data.responseRequestModel;
                        document.getElementById("profile-details").innerHTML = `
                            <strong>Full Name:</strong> ${p.fullName} <br>
                            <strong>Email:</strong> ${p.email} <br>
                            <strong>Phone:</strong> ${p.phoneNumber} <br>
                            <strong>Gender:</strong> ${p.genderDisplay} <br>
                            <strong>Role:</strong> ${p.roleDisplay} <br>
                            <strong>Created At:</strong> ${p.createdAt}
                        `;
                    } else {
                        document.getElementById("profile-details").innerText = "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin profile.";
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi l·∫•y profile:", err);
                    document.getElementById("profile-details").innerText = "L·ªói khi l·∫•y profile.";
                });
        }

        function getWalletInfo(token) {
            fetch('https://pdcbackendapi.tlog.website/api/v1/wallet', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.isSuccess) {
                        const w = data.responseRequestModel;
                        document.getElementById("wallet-details").innerHTML = `
                            <strong>M√£ v√≠:</strong> ${w.walletID}<br>
                            <strong>S·ªë d∆∞:</strong> ${w.balance}ƒë<br>
                            <strong>ƒêang kho√°:</strong> ${w.locked}ƒë<br>
                        `;
                    } else {
                        document.getElementById("wallet-details").innerText = "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin v√≠.";
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi l·∫•y v√≠:", err);
                    document.getElementById("wallet-details").innerText = "L·ªói khi l·∫•y th√¥ng tin v√≠.";
                });
        }

        function getNotifications(token, accountId) {
            fetch(`https://pdcbackendapi.tlog.website/api/v1/notification?accountId=${accountId}`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(response => response.json())
                .then(data => {
                    const notiList = document.getElementById("noti-list");
                    notiList.innerHTML = '';
                    const notifications = data.responseRequestModel.responseList.items;
                    notifications.forEach(notification => addNotificationToList(notification));
                })
                .catch(err => {
                    console.error("L·ªói khi l·∫•y th√¥ng b√°o:", err);
                    document.getElementById("noti-list").innerText = "L·ªói khi l·∫•y th√¥ng b√°o.";
                });
        }

        function addNotificationToList(notification) {
            const notiList = document.getElementById("noti-list");
            const li = document.createElement("li");
            li.id = notification.notificationID;
            li.innerHTML = `
        [${notification.title}]-${notification.message} (Time: ${new Date(notification.createdAt).toLocaleString()})
                <button onclick="deleteNotification('${notification.notificationID}')" style="margin-left: 10px; color: red;">‚ùå</button>
            `;
            notiList.prepend(li);
        }

        function deleteNotification(notificationId) {
            const token = localStorage.getItem("accessToken");
            fetch(`https://pdcbackendapi.tlog.website/api/v1/notification/${notificationId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(response => {
                    if (response.ok) {
                        const item = document.getElementById(notificationId);
                        if (item) item.remove();
                        console.log(`‚úÖ ƒê√£ xo√° th√¥ng b√°o ${notificationId}`);
                    } else {
                        console.error("‚ùå Kh√¥ng th·ªÉ xo√° th√¥ng b√°o:", response.status);
                        alert("Xo√° kh√¥ng th√†nh c√¥ng.");
                    }
                })
                .catch(error => {
                    console.error("L·ªói khi xo√° th√¥ng b√°o:", error);
                    alert("L·ªói khi xo√°.");
                });
        }

        function reloadNotifications() {
            const token = localStorage.getItem("accessToken");
            const accountId = localStorage.getItem("accountId");
            if (!token || !accountId) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ t·∫£i th√¥ng b√°o.");
                return;
            }
            getNotifications(token, accountId);
        }
    </script>
</body>

</html>